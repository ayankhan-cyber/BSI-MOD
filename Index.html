<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="BSI MODS PRO - The ultimate hub for BSI mods, skins, and customizations">
    <title>BSI MODS PRO - Ultimate Hub</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-dark: #0b1120;
            --bg-card: #1e293b;
            --primary: #3b82f6;
            --accent: #8b5cf6;
            --neon: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: rgba(255,255,255,0.1);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Outfit', sans-serif; 
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow-x: hidden;
            padding-bottom: 50px;
            line-height: 1.6;
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .btn { 
            padding: 12px 24px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s ease; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 14px;
            text-decoration: none;
        }
        .btn-primary { 
            background: linear-gradient(45deg, var(--primary), var(--accent)); 
            color: white; 
        }
        .btn-primary:hover { 
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); 
            transform: translateY(-2px); 
        }
        .btn-outline { 
            border: 1px solid var(--text-muted); 
            background: transparent; 
            color: var(--text-muted); 
        }
        .btn-outline:hover { 
            border-color: var(--text-main); 
            color: var(--text-main); 
        }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        
        .loading { opacity: 0.7; pointer-events: none; }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background: var(--bg-card);
            border-left: 4px solid var(--primary);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 350px;
            animation: slideInRight 0.3s ease;
        }
        
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* --- NAVIGATION --- */
        nav {
            background: rgba(11, 17, 32, 0.95);
            backdrop-filter: blur(10px);
            position: sticky; 
            top: 0; 
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
            padding: 15px 0;
        }
        .nav-container { 
            max-width: 1200px; 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 20px; 
        }
        .logo { 
            font-size: 24px; 
            font-weight: 800; 
            color: white; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            cursor: pointer; 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .logo span { color: var(--neon); }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-item { 
            color: var(--text-muted); 
            cursor: pointer; 
            transition: 0.3s; 
            padding: 8px 12px;
            border-radius: 6px;
        }
        .nav-item:hover, .nav-item.active { 
            color: var(--neon); 
            background: rgba(6, 182, 212, 0.1);
        }

        /* --- AUTH SECTION --- */
        .auth-container {
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            background: radial-gradient(circle at center, rgba(59,130,246,0.1), transparent);
            padding: 20px;
        }
        .auth-box {
            background: var(--bg-card); 
            padding: 40px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 400px;
            border: 1px solid var(--border-color); 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            text-align: center;
        }
        .divider { 
            margin: 20px 0; 
            position: relative; 
            text-align: center; 
        }
        .divider::before { 
            content: ''; 
            position: absolute; 
            top: 50%; 
            left: 0; 
            width: 100%; 
            height: 1px; 
            background: var(--border-color); 
        }
        .divider span { 
            position: relative; 
            background: var(--bg-card); 
            padding: 0 10px; 
            color: var(--text-muted); 
            font-size: 12px; 
        }

        /* Google Button Alignment */
        .g_id_signin { 
            display: flex; 
            justify-content: center; 
            margin-bottom: 15px; 
        }

        .input-group { 
            margin-bottom: 20px; 
            text-align: left; 
        }
        .input-group label { 
            display: block; 
            margin-bottom: 8px; 
            color: var(--text-muted); 
            font-size: 14px; 
            font-weight: 500;
        }
        .input-field { 
            width: 100%; 
            padding: 12px; 
            background: rgba(0,0,0,0.2); 
            border: 1px solid var(--border-color); 
            color: white; 
            border-radius: 8px; 
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .input-field:focus { 
            outline: none; 
            border-color: var(--neon); 
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }
        .input-field.error { border-color: var(--danger); }
        
        .error-message {
            color: var(--danger);
            font-size: 12px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* --- HOME GRID --- */
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 30px 20px; 
        }
        .section-title { 
            font-size: 32px; 
            margin-bottom: 30px; 
            font-weight: 800; 
        }

        .filter-bar { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 30px; 
            overflow-x: auto; 
            padding-bottom: 10px; 
        }
        .filter-btn { 
            background: rgba(255,255,255,0.05); 
            padding: 8px 20px; 
            border-radius: 20px; 
            cursor: pointer; 
            white-space: nowrap; 
            border: 1px solid transparent; 
            transition: all 0.3s;
            font-size: 14px;
        }
        .filter-btn.active { 
            background: var(--neon); 
            color: #000; 
            font-weight: bold; 
        }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 25px; 
        }
        .card {
            background: var(--bg-card); 
            border-radius: 15px; 
            overflow: hidden;
            border: 1px solid var(--border-color); 
            transition: 0.3s; 
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .card:hover { 
            transform: translateY(-10px); 
            border-color: var(--neon); 
            box-shadow: 0 10px 30px rgba(6, 182, 212, 0.2); 
        }
        .card-img { 
            height: 180px; 
            background-size: cover; 
            background-position: center; 
            position: relative; 
        }
        .card-badge { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            background: rgba(0,0,0,0.8); 
            padding: 4px 10px; 
            border-radius: 5px; 
            font-size: 12px; 
            color: var(--neon); 
            border: 1px solid var(--neon); 
            text-transform: uppercase;
            font-weight: 600;
        }
        .card-body { 
            padding: 20px; 
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .card-title { 
            font-size: 18px; 
            margin-bottom: 5px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            font-weight: 600;
        }
        .card-author { 
            font-size: 12px; 
            color: var(--text-muted); 
            margin-bottom: 15px; 
        }
        .card-meta {
            display: flex;
            justify-content: space-between;
            color: var(--text-muted);
            font-size: 13px;
            margin-top: auto;
        }

        /* --- MOD DETAILS MODAL --- */
        .modal-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.85); 
            z-index: 1000; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            backdrop-filter: blur(5px); 
            opacity: 0; 
            pointer-events: none; 
            transition: 0.3s;
            padding: 20px;
        }
        .modal-overlay.open { 
            opacity: 1; 
            pointer-events: all; 
        }
        .modal-content {
            background: var(--bg-card); 
            width: 100%; 
            max-width: 800px; 
            border-radius: 20px; 
            overflow: hidden;
            display: flex; 
            flex-direction: column; 
            max-height: 90vh;
            border: 1px solid var(--neon); 
            box-shadow: 0 0 50px rgba(6, 182, 212, 0.3);
        }
        .modal-header { 
            height: 250px; 
            background-size: cover; 
            background-position: center; 
            position: relative; 
        }
        .close-modal { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            background: rgba(0,0,0,0.5); 
            color: white; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            border: none; 
            cursor: pointer; 
            font-size: 20px; 
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        .close-modal:hover {
            background: rgba(0,0,0,0.7);
        }
        .modal-body { 
            padding: 30px; 
            overflow-y: auto; 
        }
        .modal-meta { 
            display: flex; 
            gap: 20px; 
            margin-bottom: 20px; 
            color: var(--text-muted); 
            font-size: 14px; 
            flex-wrap: wrap;
        }
        .modal-desc { 
            line-height: 1.6; 
            color: #ccc; 
            margin-bottom: 30px; 
            background: rgba(0,0,0,0.2); 
            padding: 15px; 
            border-radius: 10px; 
            white-space: pre-line;
        }

        /* --- PROFILE & UPLOAD --- */
        .profile-header {
            background: linear-gradient(to right, var(--bg-card), rgba(6, 182, 212, 0.1));
            padding: 40px; 
            border-radius: 20px; 
            margin-bottom: 30px; 
            display: flex; 
            align-items: center; 
            gap: 30px;
            flex-wrap: wrap;
        }
        .avatar { 
            width: 100px; 
            height: 100px; 
            background: var(--primary); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 40px; 
            font-weight: bold; 
            color: white; 
            border: 4px solid rgba(255,255,255,0.1); 
            object-fit: cover; 
        }
        .stats-grid { 
            display: flex; 
            gap: 40px; 
            margin-top: 10px; 
            flex-wrap: wrap;
        }
        .stat-item strong { 
            font-size: 24px; 
            display: block; 
            color: white; 
        }
        .stat-item span { 
            color: var(--text-muted); 
            font-size: 14px; 
        }
        .upload-zone {
            border: 2px dashed var(--text-muted); 
            padding: 40px; 
            text-align: center; 
            border-radius: 15px;
            cursor: pointer; 
            transition: 0.3s; 
            margin-bottom: 20px;
        }
        .upload-zone:hover, .upload-zone.dragover { 
            border-color: var(--neon); 
            background: rgba(6, 182, 212, 0.05); 
        }
        
        /* Footer */
        footer {
            background: var(--bg-card);
            padding: 30px 20px;
            margin-top: 50px;
            border-top: 1px solid var(--border-color);
        }
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .footer-links {
            display: flex;
            gap: 20px;
        }
        .footer-links a {
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.3s;
        }
        .footer-links a:hover {
            color: var(--neon);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-links {
                gap: 10px;
            }
            
            .nav-item {
                padding: 6px 10px;
                font-size: 14px;
            }
            
            .profile-header {
                padding: 30px 20px;
                justify-content: center;
                text-align: center;
            }
            
            .stats-grid {
                gap: 20px;
                justify-content: center;
            }
            
            .modal-content {
                flex-direction: column;
            }
            
            .modal-header {
                height: 200px;
            }
            
            .footer-content {
                flex-direction: column;
                text-align: center;
            }
        }

        @media (min-width: 768px) {
            .modal-content { 
                flex-direction: row; 
            }
            .modal-header { 
                width: 40%; 
                height: auto; 
            }
            .modal-body { 
                width: 60%; 
            }
        }
    </style>
</head>
<body>

    <nav id="navbar" class="hidden">
        <div class="nav-container">
            <div class="logo" onclick="app.navigate('home')">
                <i class="fas fa-cube"></i> BSI<span>MODS</span>
            </div>
            <div class="nav-links">
                <div class="nav-item" id="nav-home" onclick="app.navigate('home')">Home</div>
                <div class="nav-item" id="nav-upload" onclick="app.navigate('upload')">Upload</div>
                <div class="nav-item" id="nav-profile" onclick="app.navigate('profile')">Profile</div>
                <button class="btn btn-outline" onclick="app.logout()">Logout</button>
            </div>
        </div>
    </nav>

    <section id="page-auth" class="auth-container">
        <div class="auth-box" id="login-form">
            <h2 style="margin-bottom: 20px; color: var(--neon);">Welcome Back</h2>
            
            <div id="g_id_onload"
                 data-client_id="YOUR_GOOGLE_CLIENT_ID_HERE" 
                 data-callback="handleGoogleLogin"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin"
                 data-type="standard"
                 data-size="large"
                 data-theme="filled_blue"
                 data-text="sign_in_with"
                 data-shape="rectangular"
                 data-logo_alignment="left">
            </div>

            <div class="divider"><span>OR</span></div>

            <div class="input-group">
                <label for="login-user">Username</label>
                <input type="text" id="login-user" class="input-field" placeholder="Enter your username">
                <div id="login-user-error" class="error-message hidden"></div>
            </div>
            <div class="input-group">
                <label for="login-pass">Password</label>
                <input type="password" id="login-pass" class="input-field" placeholder="••••••••">
                <div id="login-pass-error" class="error-message hidden"></div>
            </div>
            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="app.login()">LOGIN</button>
            <p style="margin-top: 15px; color: var(--text-muted); font-size: 14px;">
                New here? <span style="color: var(--primary); cursor: pointer;" onclick="app.toggleAuth()">Create Account</span>
            </p>
        </div>

        <div class="auth-box hidden" id="register-form">
            <h2 style="margin-bottom: 20px; color: var(--accent);">Create Account</h2>
            <div class="input-group">
                <label for="reg-user">Choose Username</label>
                <input type="text" id="reg-user" class="input-field" placeholder="Enter a username">
                <div id="reg-user-error" class="error-message hidden"></div>
            </div>
            <div class="input-group">
                <label for="reg-pass">Password</label>
                <input type="password" id="reg-pass" class="input-field" placeholder="Create a password">
                <div id="reg-pass-error" class="error-message hidden"></div>
            </div>
            <button class="btn btn-primary" style="width: 100%; justify-content: center; background: var(--accent);" onclick="app.register()">SIGN UP</button>
            <p style="margin-top: 15px; color: var(--text-muted); font-size: 14px;">
   New here? <span style="color: var(--primary); cursor: pointer;" onclick="app.toggleAuth()">Create Account</span>
            </p>
        </div>

        <div class="auth-box hidden" id="register-form">
            <h2 style="margin-bottom: 20px; color: var(--accent);">Create Account</h2>
            <div class="input-group">
                <label for="reg-user">Choose Username</label>
                <input type="text" id="reg-user" class="input-field" placeholder="Enter a username">
                <div id="reg-user-error" class="error-message hidden"></div>
            </div>
            <div class="input-group">
                <label for="reg-pass">Password</label>
                <input type="password" id="reg-pass" class="input-field" placeholder="Create a password">
                <div id="reg-pass-error" class="error-message hidden"></div>
            </div>
            <button class="btn btn-primary" style="width: 100%; justify-content: center; background: var(--accent);" onclick="app.register()">SIGN UP</button>
            <p style="margin-top: 15px; color: var(--text-muted); font-size: 14px;">
                Already have an account? <span style="color: var(--primary); cursor: pointer;" onclick="app.toggleAuth()">Login</span>
            </p>
        </div>
    </section>

    <section id="page-home" class="hidden">
        <div style="background: radial-gradient(at top, #1e1b4b, #0b1120); padding: 60px 20px; text-align: center;">
            <h1 style="font-size: 3rem; margin-bottom: 10px;">FIND YOUR <span style="color: var(--neon);">DREAM RIDE</span></h1>
            <p style="color: var(--text-muted); max-width: 600px; margin: 0 auto;">The largest community collection of BSI Mods & Skins. Download, customize, and enhance your gaming experience.</p>
        </div>

        <div class="container">
            <div class="filter-bar">
                <button class="filter-btn active" onclick="app.filterMods('all', this)">All</button>
                <button class="filter-btn" onclick="app.filterMods('bus', this)">Bus</button>
                <button class="filter-btn" onclick="app.filterMods('truck', this)">Truck</button>
                <button class="filter-btn" onclick="app.filterMods('car', this)">Cars</button>
                <button class="filter-btn" onclick="app.filterMods('map', this)">Maps</button>
            </div>
            <div id="mod-grid" class="grid"></div>
        </div>
    </section>

    <section id="page-upload" class="container hidden">
        <h2 class="section-title">Upload New Mod</h2>
        <div class="auth-box" style="max-width: 800px; margin: 0 auto; text-align: left;">
            <div class="input-group">
                <label for="up-title">Mod Title</label>
                <input type="text" id="up-title" class="input-field" placeholder="Ex: Jetbus 5 Full Anim">
                <div id="up-title-error" class="error-message hidden"></div>
            </div>
            <div class="input-group" style="display: flex; gap: 20px;">
                <div style="flex:1;">
                    <label for="up-cat">Category</label>
                    <select id="up-cat" class="input-field">
                        <option value="bus">Bus</option>
                        <option value="truck">Truck</option>
                        <option value="car">Car</option>
                        <option value="map">Map</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label for="up-size">File Size (MB)</label>
                    <input type="text" id="up-size" class="input-field" placeholder="Ex: 15MB">
                    <div id="up-size-error" class="error-message hidden"></div>
                </div>
            </div>
            <div class="input-group">
                <label for="up-desc">Description</label>
                <textarea id="up-desc" class="input-field" rows="4" placeholder="Describe features, requirements, and any special notes..."></textarea>
                <div id="up-desc-error" class="error-message hidden"></div>
            </div>
            <div class="upload-zone" id="drop-zone">
                <i class="fas fa-image" style="font-size: 30px; margin-bottom: 10px; color: var(--text-muted);"></i>
                <p>Click to upload Thumbnail Image</p>
                <input type="file" id="up-img" hidden accept="image/*">
                <p id="file-name" style="color: var(--neon); margin-top: 10px; font-size: 14px;"></p>
            </div>
            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="app.submitMod()">PUBLISH MOD</button>
        </div>
    </section>

    <section id="page-profile" class="container hidden">
        <div class="profile-header">
            <img id="profile-avatar-img" class="avatar hidden" src="" alt="Profile">
            <div id="profile-avatar-text" class="avatar">U</div>
            
            <div>
                <h2 id="profile-name">Username</h2>
                <p style="color: var(--neon);">Verified Creator</p>
                <div class="stats-grid">
                    <div class="stat-item"><strong id="stat-uploads">0</strong> <span>Uploads</span></div>
                    <div class="stat-item"><strong id="stat-downloads">0</strong> <span>Total Downloads</span></div>
                </div>
            </div>
        </div>
        <h3>My Uploads</h3>
        <hr style="border-color: rgba(255,255,255,0.1); margin: 20px 0;">
        <div id="profile-grid" class="grid"></div>
    </section>

    <div class="modal-overlay" id="detail-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="app.closeModal()" aria-label="Close modal">&times;</button>
            <div class="modal-header" id="m-img"></div>
            <div class="modal-body">
                <span class="card-badge" id="m-cat" style="position:relative; top:0; right:0; display:inline-block; margin-bottom:10px;">BUS</span>
                <h2 id="m-title" style="font-size: 28px; margin-bottom: 10px;">Title</h2>
                <div class="modal-meta">
                    <span><i class="fas fa-user"></i> <span id="m-author">Author</span></span>
                    <span><i class="fas fa-hdd"></i> <span id="m-size">10MB</span></span>
                    <span><i class="fas fa-download"></i> <span id="m-downloads">0</span></span>
                </div>
                <div class="modal-desc" id="m-desc"></div>
                <button class="btn btn-primary" style="width: 100%; justify-content: center; padding: 15px;" onclick="app.downloadFile()">
                    <i class="fas fa-download"></i> DOWNLOAD MOD FILE
                </button>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="footer-content">
            <div class="logo">
                <i class="fas fa-cube"></i> BSI<span>MODS</span>
            </div>
            <div class="footer-links">
                <a href="#" onclick="app.navigate('home')">Home</a>
                <a href="#" onclick="app.navigate('upload')">Upload</a>
                <a href="#" onclick="app.navigate('profile')">Profile</a>
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
            </div>
        </div>
    </footer>

    <div class="toast-container" id="toast-container"></div>
    <script>
        // Global function for Google callback
        function handleGoogleLogin(response) {
            const responsePayload = parseJwt(response.credential);
            
            // Create a user object from Google data
            const googleUser = {
                username: responsePayload.name,
                email: responsePayload.email,
                picture: responsePayload.picture,
                uploads: 0,
                totalDownloads: 0,
                type: 'google'
            };

            // Save to localStorage and Login
            localStorage.setItem('bsi_current_user', JSON.stringify(googleUser));
            app.currentUser = googleUser;
            app.navigate('home');
            app.showToast('Successfully logged in with Google!', 'success');
        }

        // Helper to decode Google JWT
        function parseJwt (token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        class App {
            constructor() {
                this.currentUser = null;
                this.mods = JSON.parse(localStorage.getItem('bsi_mods')) || [
                    { id: 1, title: "Jetbus 5 SDD Voyager", cat: "bus", size: "25MB", desc: "Full animation, strobe lights included.", author: "Admin", img: "https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=600", downloads: 120 },
                    { id: 2, title: "Hino 500 Heavy Load", cat: "truck", size: "18MB", desc: "Heavy cargo trucking mod.", author: "TruckMaster", img: "https://images.unsplash.com/photo-1601584115197-04ecc0cd31d7?w=600", downloads: 85 }
                ];
                this.users = JSON.parse(localStorage.getItem('bsi_users')) || [];
                this.init();
            }

            init() {
                const savedUser = localStorage.getItem('bsi_current_user');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.navigate('home');
                } else {
                    this.navigate('auth');
                }

                // File upload handling
                document.getElementById('drop-zone').addEventListener('click', () => document.getElementById('up-img').click());
                document.getElementById('up-img').addEventListener('change', (e) => {
                    if(e.target.files[0]) {
                        const fileName = e.target.files[0].name;
                        document.getElementById('file-name').innerText = fileName;
                        
                        // Validate file type
                        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                        if (!validTypes.includes(e.target.files[0].type)) {
                            this.showToast('Please upload a valid image file (JPEG, PNG, GIF, WebP)', 'error');
                            document.getElementById('up-img').value = '';
                            document.getElementById('file-name').innerText = '';
                        }
                    }
                });
                
                // Drag and drop functionality
                const dropZone = document.getElementById('drop-zone');
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('dragover');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    
                    if (e.dataTransfer.files.length) {
                        document.getElementById('up-img').files = e.dataTransfer.files;
                        const event = new Event('change');
                        document.getElementById('up-img').dispatchEvent(event);
                    }
                });
                
                // Input validation on blur
                document.getElementById('reg-user').addEventListener('blur', () => this.validateUsername('reg-user'));
                document.getElementById('reg-pass').addEventListener('blur', () => this.validatePassword('reg-pass'));
                document.getElementById('login-user').addEventListener('blur', () => this.validateRequired('login-user'));
                document.getElementById('login-pass').addEventListener('blur', () => this.validateRequired('login-pass'));
            }

            // --- SECURITY: Sanitize Input to prevent XSS ---
            escapeHtml(text) {
                if (!text) return "";
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // --- VALIDATION FUNCTIONS ---
            validateRequired(fieldId) {
                const field = document.getElementById(fieldId);
                const errorElement = document.getElementById(`${fieldId}-error`);
                const value = field.value.trim();
                
                if (!value) {
                    field.classList.add('error');
                    errorElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> This field is required';
                    errorElement.classList.remove('hidden');
                    return false;
                } else {
                    field.classList.remove('error');
                    errorElement.classList.add('hidden');
                    return true;
                }
            }
            
            validateUsername(fieldId) {
                const field = document.getElementById(fieldId);
                const errorElement = document.getElementById(`${fieldId}-error`);
                const value = field.value.trim();
                
                if (!value) {
                    field.classList.add('error');
                    errorElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> Username is required';
                    errorElement.classList.remove('hidden');
                    return false;
                } else if (value.length < 3) {
                    field.classList.add('error');
                    errorElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> Username must be at least 3 characters';
                    errorElement.classList.remove('hidden');
                    return false;
                } else if (this.users.find(u => u.username === value)) {
                    field.classList.add('error');
                    errorElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> Username is already taken';
                    errorElement.classList.remove('hidden');
                    return false;
                } else {
                    field.classList.remove('error');
                    errorElement.classList.add('hidden');
                    return true;
                }
            }
            
            validatePassword(fieldId) {
                const field = document.getElementById(fieldId);
                const errorElement = document.getElementById(`${fieldId}-error`);
                const value = field.value;
                
                if (!value) {
                    field.classList.add('error');
                    errorElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> Password is required';
                    errorElement.classList.remove('hidden');
                    return false;
                } else if (value.length < 6) {
                    field.classList.add('error');
                    errorElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> Password must be at least 6 characters';
                    errorElement.classList.remove('hidden');
                    return false;
                } else {
                    field.classList.remove('error');
                    errorElement.classList.add('hidden');
                    return true;
                }
            }

            navigate(page) {
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                document.getElementById('navbar').classList.add('hidden');

                if (page === 'auth') {
                    document.getElementById('page-auth').classList.remove('hidden');
                } else {
                    document.getElementById('navbar').classList.remove('hidden');
                    document.getElementById(`page-${page}`).classList.remove('hidden');
                    
                    // Robust Active State Logic
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    const activeNav = document.getElementById(`nav-${page}`);
                    if(activeNav) activeNav.classList.add('active');
                    
                    if(page === 'home') this.renderMods('all');
                    if(page === 'profile') this.renderProfile();
                }
            }

            toggleAuth() {
                document.getElementById('login-form').classList.toggle('hidden');
                document.getElementById('register-form').classList.toggle('hidden');
                
                // Clear validation errors when switching forms
                document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.input-field').forEach(el => el.classList.remove('error'));
            }

            register() {
                const userValid = this.validateUsername('reg-user');
                const passValid = this.validatePassword('reg-pass');
                
                if(!userValid || !passValid) return;
                
                const user = this.escapeHtml(document.getElementById('reg-user').value);
                const pass = document.getElementById('reg-pass').value;

                const newUser = { 
                    username: user, 
                    password: pass, 
                    uploads: 0, 
                    totalDownloads: 0, 
                    type: 'local',
                    joinDate: new Date().toISOString()
                };
                this.users.push(newUser);
                localStorage.setItem('bsi_users', JSON.stringify(this.users));
                this.showToast('Account created successfully! Please login.', 'success');
                this.toggleAuth();
            }

            login() {
                const userValid = this.validateRequired('login-user');
                const passValid = this.validateRequired('login-pass');
                
                if(!userValid || !passValid) return;
                
                const user = this.escapeHtml(document.getElementById('login-user').value);
                const pass = document.getElementById('login-pass').value;
                const foundUser = this.users.find(u => u.username === user && u.password === pass);
                
                if ((user === 'admin' && pass === 'admin') || foundUser) {
                    this.currentUser = foundUser || { 
                        username: 'Admin', 
                        uploads: 5, 
                        totalDownloads: 1200, 
                        type: 'admin',
                        joinDate: new Date().toISOString()
                    };
                    localStorage.setItem('bsi_current_user', JSON.stringify(this.currentUser));
                    this.navigate('home');
                    this.showToast(`Welcome back, ${this.currentUser.username}!`, 'success');
                } else {
                    this.showToast('Invalid username or password', 'error');
                }
            }

            logout() {
                this.currentUser = null;
                localStorage.removeItem('bsi_current_user');
                this.navigate('auth');
                this.showToast('You have been logged out', 'warning');
                // Reload to reset Google state if necessary
                setTimeout(() => window.location.reload(), 1000);
            }

            renderMods(filter, btnElement) {
                const grid = document.getElementById('mod-grid');
                grid.innerHTML = '';

                if(btnElement) {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btnElement.classList.add('active');
                }

                const filteredData = filter === 'all' ? this.mods : this.mods.filter(m => m.cat === filter);
                
                if (filteredData.length === 0) {
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <h3>No mods found</h3>
                            <p>Try a different filter or check back later for new uploads.</p>
                        </div>
                    `;
                    return;
                }

                filteredData.forEach(mod => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-img" style="background-image: url('${mod.img}')">
                            <span class="card-badge">${mod.cat.toUpperCase()}</span>
                        </div>
                        <div class="card-body">
                            <h3 class="card-title">${this.escapeHtml(mod.title)}</h3>
                            <div class="card-author">By ${this.escapeHtml(mod.author)}</div>
                            <div class="card-meta">
                                <span><i class="fas fa-hdd"></i> ${this.escapeHtml(mod.size)}</span>
                                <span><i class="fas fa-download"></i> ${mod.downloads}</span>
                            </div>
                        </div>
                    `;
                    card.onclick = () => this.openModal(mod);
                    grid.appendChild(card);
                });
            }

            renderProfile() {
                const textAvatar = document.getElementById('profile-avatar-text');
                const imgAvatar = document.getElementById('profile-avatar-img');
                
                document.getElementById('profile-name').innerText = this.currentUser.username;

                // Handle Google Profile Picture vs Text Avatar
                if (this.currentUser.picture) {
                    textAvatar.classList.add('hidden');
                    imgAvatar.classList.remove('hidden');
                    imgAvatar.src = this.currentUser.picture;
                    imgAvatar.alt = `${this.currentUser.username}'s profile picture`;
                } else {
                    imgAvatar.classList.add('hidden');
                    textAvatar.classList.remove('hidden');
                    textAvatar.innerText = this.currentUser.username[0].toUpperCase();
                }

                const myMods = this.mods.filter(m => m.author === this.currentUser.username);
                const totalDl = myMods.reduce((sum, mod) => sum + mod.downloads, 0);
                
                document.getElementById('stat-uploads').innerText = myMods.length;
                document.getElementById('stat-downloads').innerText = totalDl + (this.currentUser.totalDownloads || 0);

                const pGrid = document.getElementById('profile-grid');
                pGrid.innerHTML = '';
                
                if(myMods.length === 0) {
                    pGrid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-upload" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <h3>No uploads yet</h3>
                            <p>Start sharing your creations with the community!</p>
                            <button class="btn btn-primary" style="margin-top: 15px;" onclick="app.navigate('upload')">
                                <i class="fas fa-plus"></i> Upload Your First Mod
                            </button>
                        </div>
                    `;
                    return;
                }

                myMods.forEach(mod => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-img" style="background-image: url('${mod.img}')"></div>
                        <div class="card-body">
                            <h3 class="card-title">${this.escapeHtml(mod.title)}</h3>
                            <div style="color: var(--neon); font-size: 13px;">${mod.downloads} Downloads</div>
                        </div>
                    `;
                    card.onclick = () => this.openModal(mod);
                    pGrid.appendChild(card);
                });
            }

            submitMod() {
                // Validate inputs
                const title = this.escapeHtml(document.getElementById('up-title').value.trim());
                const cat = document.getElementById('up-cat').value;
                const size = this.escapeHtml(document.getElementById('up-size').value.trim());
                const desc = this.escapeHtml(document.getElementById('up-desc').value.trim());
                const fileInput = document.getElementById('up-img');

                // Clear previous errors
                document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.input-field').forEach(el => el.classList.remove('error'));

                let hasErrors = false;
                
                if(!title) {
                    document.getElementById('up-title').classList.add('error');
                    document.getElementById('up-title-error').innerHTML = '<i class="fas fa-exclamation-circle"></i> Mod title is required';
                    document.getElementById('up-title-error').classList.remove('hidden');
                    hasErrors = true;
                }
                
                if(!size) {
                    document.getElementById('up-size').classList.add('error');
                    document.getElementById('up-size-error').innerHTML = '<i class="fas fa-exclamation-circle"></i> File size is required';
                    document.getElementById('up-size-error').classList.remove('hidden');
                    hasErrors = true;
                }
                
                if(!desc) {
                    document.getElementById('up-desc').classList.add('error');
                    document.getElementById('up-desc-error').innerHTML = '<i class="fas fa-exclamation-circle"></i> Description is required';
                    document.getElementById('up-desc-error').classList.remove('hidden');
                    hasErrors = true;
                }
                
                if(hasErrors) return;

                let imgUrl = "https://images.unsplash.com/photo-1570125909232-eb263c188f7e?w=600"; 
                
                const processUpload = (finalImg) => {
                    const newMod = {
                        id: Date.now(),
                        title, cat, size, desc,
                        author: this.currentUser.username,
                        img: finalImg,
                        downloads: 0,
                        uploadDate: new Date().toISOString()
                    };

                    this.mods.unshift(newMod);
                    localStorage.setItem('bsi_mods', JSON.stringify(this.mods));
                    this.showToast('Mod uploaded successfully!', 'success');
                    document.getElementById('up-title').value = '';
                    document.getElementById('up-desc').value = '';
                    document.getElementById('up-size').value = '';
                    document.getElementById('file-name').innerText = '';
                    this.navigate('home');
                }

                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        processUpload(e.target.result);
                    }
                    reader.readAsDataURL(fileInput.files[0]);
                } else {
                    processUpload(imgUrl);
                }
            }

            openModal(mod) {
                this.currentMod = mod;
                document.getElementById('m-img').style.backgroundImage = `url('${mod.img}')`;
                document.getElementById('m-title').innerText = this.escapeHtml(mod.title);
                document.getElementById('m-cat').innerText = mod.cat.toUpperCase();
                document.getElementById('m-author').innerText = this.escapeHtml(mod.author);
                document.getElementById('m-size').innerText = this.escapeHtml(mod.size);
                document.getElementById('m-downloads').innerText = mod.downloads;
                document.getElementById('m-desc').innerText = this.escapeHtml(mod.desc);
                document.getElementById('detail-modal').classList.add('open');
                
                // Close modal when clicking outside
                document.getElementById('detail-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'detail-modal') {
                        this.closeModal();
                    }
                });
                
                // Close modal with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeModal();
                    }
                });
            }

            closeModal() {
                document.getElementById('detail-modal').classList.remove('open');
                document.getElementById('detail-modal').removeEventListener('click', () => {});
                document.removeEventListener('keydown', () => {});
            }

            downloadFile() {
                if (!this.currentMod) return;
                
                this.currentMod.downloads++;
                localStorage.setItem('bsi_mods', JSON.stringify(this.mods));
                
                // Update the current user's download stats if they're the author
                if (this.currentUser.username === this.currentMod.author) {
                    this.currentUser.totalDownloads = (this.currentUser.totalDownloads || 0) + 1;
                    localStorage.setItem('bsi_current_user', JSON.stringify(this.currentUser));
                }
                
                const element = document.createElement('a');
                const fileContent = `BSI MOD FILE\nTitle: ${this.currentMod.title}\nAuthor: ${this.currentMod.author}\nCategory: ${this.currentMod.cat}\nSize: ${this.currentMod.size}\nDescription: ${this.currentMod.desc}\n\nThank you for downloading from BSI MODS PRO!`;
                const blob = new Blob([fileContent], {type: 'text/plain'});
                const url = URL.createObjectURL(blob); // Create URL
                
                element.href = url;
                element.download = `${this.currentMod.title.replace(/\s+/g, '_')}.bussidmod`;
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                
                // Clean up memory
                setTimeout(() => URL.revokeObjectURL(url), 100); 

                const btn = document.querySelector('.modal-body .btn-primary');
                const originalText = btn.innerHTML;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> DOWNLOADING...`;
                btn.classList.add('loading');
                
                setTimeout(() => {
                    this.closeModal();
                    if(!document.getElementById('page-home').classList.contains('hidden')) {
                        this.renderMods('all');
                    }
                    btn.innerHTML = originalText;
                    btn.classList.remove('loading');
                    this.showToast('Download completed!', 'success');
                }, 1500);
            }
            
            showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                let icon = 'fa-check-circle';
                if (type === 'error') icon = 'fa-exclamation-circle';
                if (type === 'warning') icon = 'fa-exclamation-triangle';
                
                toast.innerHTML = `
                    <i class="fas ${icon}"></i>
                    <span>${message}</span>
                `;
                
                toastContainer.appendChild(toast);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    toast.style.animation = 'slideInRight 0.3s ease reverse';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 5000);
            }
        }

        const app = new App();
    </script>
</body>
</html>
